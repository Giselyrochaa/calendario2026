<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Comunicação - Instituto Evereste</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Impressão Retrato A4 */
        @media print {
            @page { margin: 0.8cm; size: portrait; }
            body { background-color: white !important; font-size: 10px; color: black !important; }
            header, .no-print, .nav-container, #connection-status-container, #initial-loader, button, .modal-confirm-btn { display: none !important; }
            #app-content { width: 100% !important; display: block !important; margin: 0 !important; padding: 0 !important; }
            .card, .bg-white, .rounded-3xl { box-shadow: none !important; border: 1px solid #e2e8f0 !important; border-radius: 8px !important; break-inside: avoid; }
            table { font-size: 7px; width: 100%; border-collapse: collapse; table-layout: fixed; }
            th, td { border: 1px solid #cbd5e1 !important; padding: 4px !important; word-wrap: break-word; color: black !important; }
            input, select, textarea { border: none !important; background: transparent !important; color: black !important; font-size: 7px !important; }
            .bg-blue-900, .bg-slate-900, .bg-red-800 { background-color: #f8fafc !important; color: black !important; border: 1px solid #e2e8f0 !important; }
            h1, h2, h3, p, span { color: black !important; }
            html, body { height: auto !important; overflow: visible !important; }
        }

        .nav-btn-active { 
            background-color: #ffffff !important; 
            color: #1e3a8a !important; 
            font-weight: 800; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        .nav-btn-inactive { color: #dbeafe !important; opacity: 0.8; }
        .nav-btn-inactive:hover { background-color: #1d4ed8 !important; opacity: 1; }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Modal de Confirmação -->
    <div id="modal-overlay" class="fixed inset-0 flex items-center justify-center z-[100] hidden no-print bg-black/50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-red-100 animate-fadeIn">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i data-lucide="alert-circle" size="24"></i>
                <h3 class="text-lg font-extrabold tracking-tight">Confirmar</h3>
            </div>
            <p id="modal-message" class="text-slate-600 mb-8 text-sm leading-relaxed">Deseja prosseguir com esta exclusão?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-xl text-sm font-bold transition">Cancelar</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-red-600 text-white hover:bg-red-700 rounded-xl shadow-lg text-sm font-black transition uppercase">Apagar</button>
            </div>
        </div>
    </div>

    <!-- Header Institucional -->
    <header class="bg-blue-900 text-white shadow-xl sticky top-0 z-40 no-print flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-11 h-11 bg-white rounded-xl flex items-center justify-center text-blue-900 font-black shadow-lg text-xl">IE</div>
                <div>
                    <h1 class="text-xl font-extrabold leading-none tracking-tighter uppercase">Instituto Evereste</h1>
                    <p class="text-[10px] text-blue-300 uppercase font-black tracking-[0.2em] mt-1">Gestão de Comunicação • 2026</p>
                </div>
            </div>

            <nav class="hidden lg:flex gap-1 bg-blue-800/40 p-1.5 rounded-2xl border border-blue-700/30">
                <button onclick="window.changeView('dashboard')" class="nav-btn px-5 py-2.5 rounded-xl text-[11px] font-bold uppercase transition-all" data-view="dashboard">Dashboard</button>
                <button onclick="window.changeView('month')" class="nav-btn px-5 py-2.5 rounded-xl text-[11px] font-bold uppercase transition-all" data-view="month">Ações</button>
                <button onclick="window.changeView('calendar')" class="nav-btn px-5 py-2.5 rounded-xl text-[11px] font-bold uppercase transition-all" data-view="calendar">Calendário</button>
                <button onclick="window.changeView('reports')" class="nav-btn px-5 py-2.5 rounded-xl text-[11px] font-bold uppercase transition-all" data-view="reports">Relatórios</button>
            </nav>

            <div class="flex items-center gap-4">
                <div id="connection-status-container" class="hidden sm:flex items-center gap-2 px-4 py-2 bg-blue-950/50 rounded-xl border border-blue-800/50">
                    <span id="conn-dot" class="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse"></span>
                    <span id="conn-text" class="text-[10px] font-black uppercase tracking-widest text-blue-100">Sync</span>
                </div>
                <button class="lg:hidden p-2 text-white bg-blue-800 rounded-xl" onclick="window.toggleMobileMenu()"><i data-lucide="menu"></i></button>
            </div>
        </div>
    </header>

    <!-- Área de Conteúdo -->
    <main id="app-content" class="flex-1 overflow-y-auto max-w-7xl mx-auto w-full px-4 py-8 custom-scrollbar">
        <div id="initial-loader" class="flex flex-col items-center justify-center py-40 text-slate-400">
            <div class="animate-spin rounded-full h-14 w-14 border-b-2 border-blue-900 mb-6"></div>
            <p class="font-black uppercase tracking-[0.3em] text-[10px]">A sincronizar painel unificado...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // --- CONSTANTES GLOBAIS ---
        window.MONTHS_DATA = [
            { id: 0, name: 'Janeiro', color: 'border-l-8 border-slate-300' },
            { id: 1, name: 'Fevereiro', color: 'border-l-8 border-orange-500' },
            { id: 2, name: 'Março', color: 'border-l-8 border-pink-500' },
            { id: 3, name: 'Abril', color: 'border-l-8 border-sky-500' },
            { id: 4, name: 'Maio', color: 'border-l-8 border-yellow-500' },
            { id: 5, name: 'Junho', color: 'border-l-8 border-red-500' },
            { id: 6, name: 'Julho', color: 'border-l-8 border-amber-500' },
            { id: 7, name: 'Agosto', color: 'border-l-8 border-purple-500' },
            { id: 8, name: 'Setembro', color: 'border-l-8 border-emerald-500' },
            { id: 9, name: 'Outubro', color: 'border-l-8 border-rose-500' },
            { id: 10, name: 'Novembro', color: 'border-l-8 border-indigo-600' },
            { id: 11, name: 'Dezembro', color: 'border-l-8 border-red-700' }
        ];

        window.TYPES = ['Evento Interno', 'Evento Externo', 'Palestra', 'Campanha', 'Treinamento', 'Gravação', 'Websérie', 'Oficina', 'Gravações'];
        window.STATUS = ['Planejado', 'Em Execução', 'Concluído', 'Não Realizado'];
        window.AUDIENCES = ['Interno', 'Externo', 'Parceria', 'Visitante', 'Colaborador', 'Comunidade'];
        window.SECTORS = ['Comunicação', 'Diretoria', 'Administrativo', 'RH', 'Infraestrutura', 'TI', 'CGA', 'CCSRI', 'Socioambiental', 'Ética', 'Endomarketing'];
        window.FEEDBACK_CATEGORIES = ['Crítica', 'Moderado', 'Alto Risco', 'Sem Relevância'];

        const firebaseConfig = {
            apiKey: "AIzaSyBsEubTpWMv4RvpNqgF-6Bx0po5HtCGYcs",
            authDomain: "calendario2026-463b1.firebaseapp.com",
            projectId: "calendario2026-463b1",
            storageBucket: "calendario2026-463b1.firebasestorage.app",
            messagingSenderId: "262139618414",
            appId: "1:262139618414:web:fa2feeded953c9d261f27f",
            measurementId: "G-YZED14D5EX"
        };
        
        const appId = 'evereste-2026-cga-v11';

        window.state = {
            view: 'dashboard',
            selectedMonth: new Date().getMonth(),
            activities: [],
            notifications: [],
            monthlyReports: {},
            holidays: []
        };

        window.db = null;
        window.auth = null;

        // --- FUNÇÕES DE RENDERIZAÇÃO E LÓGICA ---

        window.renderApp = () => {
            const content = document.getElementById('app-content');
            if(!content) return;

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.view === window.state.view;
                btn.className = `nav-btn px-5 py-2.5 rounded-xl text-[11px] font-black uppercase transition-all ${isActive ? 'nav-btn-active' : 'nav-btn-inactive'}`;
            });

            let mSelector = '';
            if (['month', 'reports'].includes(window.state.view)) {
                mSelector = `<div class="mb-6 overflow-x-auto pb-2 no-print custom-scrollbar"><div class="flex gap-2 min-w-max">${window.MONTHS_DATA.map(m => `<button onclick="window.changeMonth(${m.id})" class="px-4 py-2 rounded-full text-[10px] font-black border transition-all ${window.state.selectedMonth === m.id ? 'bg-blue-900 text-white border-blue-900 shadow-lg' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'} uppercase tracking-tight">${m.name}</button>`).join('')}</div></div>`;
            }

            const currentViewFn = window.templates[window.state.view];
            if (currentViewFn) {
                content.innerHTML = mSelector + currentViewFn();
            }
            
            lucide.createIcons();
            document.getElementById('initial-loader')?.classList.add('hidden');
        };

        window.getStrategicIndicatorsHTML = () => {
            const acts = window.state.activities;
            const completed = acts.filter(a => a.status === 'Concluído').length;
            const expected = acts.length;
            const rated = acts.filter(a => a.satisfaction && !isNaN(a.satisfaction));
            const avg = rated.length ? Math.round(rated.reduce((acc, c) => acc + parseFloat(c.satisfaction), 0) / rated.length) : 0;
            const totalPublic = acts.reduce((acc, c) => acc + (parseInt(c.publicCount) || 0), 0);
            
            return `
                <div class="mb-8 space-y-8 no-print animate-fadeIn">
                    <div class="flex justify-between items-center bg-white p-6 rounded-3xl border shadow-sm">
                        <h2 class="text-xl font-black text-slate-800 uppercase tracking-tighter">Indicadores Estratégicos Institucionais</h2>
                        <button onclick="window.exportPDF()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-xl flex items-center gap-2 hover:bg-blue-700 transition">
                            <i data-lucide="printer" size="14"></i> EXPORTAR PDF
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-blue-600">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Satisfação</p>
                            <h3 class="text-2xl font-black text-blue-700 leading-none">${avg}%</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-green-500">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Público Total</p>
                            <h3 class="text-2xl font-black text-green-600 leading-none">${totalPublic}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-indigo-600">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Meta Esperada</p>
                            <h3 class="text-2xl font-black text-indigo-600 leading-none">${expected}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-emerald-600">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Meta Atingida</p>
                            <h3 class="text-2xl font-black text-emerald-600 leading-none">${completed}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 border-l-4 border-l-slate-800">
                            <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Taxa Exec.</p>
                            <h3 class="text-2xl font-black text-slate-800 leading-none">${acts.length ? Math.round((completed/acts.length)*100) : 0}%</h3>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- TEMPLATES ---
        window.templates = {
            dashboard: () => {
                const acts = window.state.activities;
                const top = [...acts]
                    .filter(a => a.satisfaction && a.status === 'Concluído')
                    .sort((a,b) => b.satisfaction - a.satisfaction)
                    .slice(0,5);

                return `
                    ${window.getStrategicIndicatorsHTML()}
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fadeIn">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <h3 class="text-sm font-black text-slate-800 mb-6 uppercase tracking-widest flex items-center gap-2"><i data-lucide="award" class="text-yellow-500"></i> Eventos em Destaque (Sync Auto)</h3>
                            <div class="space-y-4">
                                ${top.map(t => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                    <div class="truncate pr-4">
                                        <p class="text-xs font-black text-slate-800 truncate uppercase">${t.eventName || 'S/ Nome'}</p>
                                        <p class="text-[9px] text-slate-400 font-bold uppercase">${t.type}</p>
                                    </div>
                                    <span class="text-sm font-black text-emerald-600">${t.satisfaction}%</span>
                                </div>`).join('') || '<p class="text-center py-10 text-slate-300 italic text-sm">A aguardar sincronização...</p>'}
                            </div>
                        </div>
                        <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <h3 class="text-sm font-black text-slate-800 mb-6 uppercase tracking-widest flex items-center gap-2"><i data-lucide="bell" class="text-blue-600"></i> Mural Unificado de Feedback</h3>
                            <div class="flex flex-col gap-2 mb-6 no-print">
                                <input type="text" id="notif-input" placeholder="Novo relato..." class="bg-slate-50 border-none p-3 rounded-xl text-xs font-medium outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="flex gap-2">
                                    <select id="notif-cat" class="flex-1 bg-slate-50 border-none p-2 rounded-xl text-[10px] font-black uppercase">
                                        ${window.FEEDBACK_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                    <button onclick="window.sendNotif()" class="bg-blue-900 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">Postar</button>
                                </div>
                            </div>
                            <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar">
                                ${window.state.notifications.map(n => `<div class="p-4 bg-blue-50 border-l-4 border-blue-600 rounded-xl flex justify-between group">
                                    <div class="flex-1">
                                        <span class="text-[8px] font-black uppercase bg-blue-100 px-2 py-0.5 rounded-full text-blue-800 mb-1 inline-block">${n.category || 'Feedback'}</span>
                                        <p class="text-xs text-blue-900 font-medium leading-relaxed">${n.text}</p>
                                        <span class="text-[8px] text-blue-400 font-black uppercase mt-1 block">${new Date(n.timestamp).toLocaleString()}</span>
                                    </div>
                                    <button onclick="window.delNotif('${n.id}')" class="text-red-300 opacity-0 group-hover:opacity-100 hover:text-red-600 transition no-print"><i data-lucide="trash-2" size="14"></i></button>
                                </div>`).join('') || '<p class="text-center py-10 text-slate-300 italic text-sm">Sem avisos.</p>'}
                            </div>
                        </div>
                    </div>`;
            },
            month: () => {
                const m = window.MONTHS_DATA[window.state.selectedMonth];
                const acts = window.state.activities.filter(a => parseInt(a.month) === m.id);
                return `
                    ${window.getStrategicIndicatorsHTML()}
                    <div class="space-y-6 animate-fadeIn">
                        <div class="bg-white p-8 rounded-3xl shadow-sm border ${m.color}">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                <div><h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">${m.name} 2026</h2><p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Controlo de Atividades e Gravações</p></div>
                                <button onclick="window.addAct()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3.5 rounded-2xl font-black text-[11px] uppercase transition shadow-xl flex items-center gap-2"><i data-lucide="plus" size="16"></i> ADICIONAR AÇÃO</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="overflow-x-auto custom-scrollbar">
                                <table class="w-full text-left text-sm whitespace-nowrap">
                                    <thead class="bg-slate-50/80 text-slate-400 font-black uppercase text-[8px] border-b">
                                        <tr>
                                            <th class="px-5 py-5 w-[140px]">Tipo</th>
                                            <th class="px-5 py-5 min-w-[200px]">Nome do Evento / Tipo</th>
                                            <th class="px-5 py-5 w-[170px]">Data / Hora</th>
                                            <th class="px-5 py-5 w-[120px]">Público</th>
                                            <th class="px-5 py-5 w-[80px]">Pres.</th>
                                            <th class="px-5 py-5 w-[140px]">Setor Resp.</th>
                                            <th class="px-5 py-5 min-w-[250px]">Palestras e Ações</th>
                                            <th class="px-5 py-5 w-[90px]">Satisf.</th>
                                            <th class="px-5 py-5 w-[130px]">Status</th>
                                            <th class="px-5 py-5 w-10 no-print"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${acts.map(a => {
                                            const isLecture = a.type === 'Palestra';
                                            return `
                                            <tr class="hover:bg-blue-50/20 transition-colors">
                                                <td class="px-6 py-4"><select onchange="window.saveAct('${a.id}', 'type', this.value)" class="w-full p-2 border rounded-xl text-[9px] font-black uppercase bg-white cursor-pointer">${window.TYPES.map(o => `<option ${a.type === o ? 'selected' : ''}>${o}</option>`).join('')}</select></td>
                                                <td class="px-6 py-4 font-bold text-slate-800"><input type="text" value="${a.eventName || ''}" onblur="window.saveAct('${a.id}', 'eventName', this.value)" class="w-full p-2 border rounded-xl text-xs font-bold" placeholder="${isLecture ? 'Nome do Evento' : 'Tipo de Evento'}"></td>
                                                <td class="px-6 py-4"><div class="flex flex-col gap-1"><input type="date" value="${a.date || ''}" onchange="window.saveAct('${a.id}', 'date', this.value)" class="p-1 border rounded text-[10px] font-black w-[125px]"><input type="time" value="${a.time || ''}" onchange="window.saveAct('${a.id}', 'time', this.value)" class="p-1 border rounded text-[10px] font-black w-[75px]"></div></td>
                                                <td class="px-6 py-4"><select onchange="window.saveAct('${a.id}', 'audience', this.value)" class="w-full p-2 border rounded-xl text-[10px] font-bold bg-white cursor-pointer">${window.AUDIENCES.map(o => `<option ${a.audience === o ? 'selected' : ''}>${o}</option>`).join('')}</select></td>
                                                <td class="px-6 py-4"><input type="number" value="${a.publicCount || ''}" onblur="window.saveAct('${a.id}', 'publicCount', this.value)" class="w-full p-2 border rounded-xl text-center font-black text-slate-600"></td>
                                                <td class="px-6 py-4"><select onchange="window.saveAct('${a.id}', 'eventSector', this.value)" class="w-full p-2 border rounded-xl text-[10px] font-bold bg-white cursor-pointer">${window.SECTORS.map(o => `<option ${a.eventSector === o ? 'selected' : ''}>${o}</option>`).join('')}</select></td>
                                                <td class="px-6 py-4"><textarea onblur="window.saveAct('${a.id}', 'postOccurrence', this.value)" class="w-full p-2 border rounded-xl text-[10px] h-12 leading-tight resize-none">${a.postOccurrence || ''}</textarea></td>
                                                <td class="px-6 py-4"><div class="flex items-center gap-1 justify-center"><input type="number" value="${a.satisfaction || ''}" onblur="window.saveAct('${a.id}', 'satisfaction', this.value)" class="w-14 p-2 border rounded-xl text-center font-black text-blue-700">%</div></td>
                                                <td class="px-6 py-4"><select onchange="window.saveAct('${a.id}', 'status', this.value)" class="w-full p-2 rounded-xl font-black text-[10px] uppercase border-none cursor-pointer ${a.status === 'Concluído' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'}">${window.STATUS.map(s => `<option ${a.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td>
                                                <td class="px-6 py-4 text-right no-print"><button onclick="window.delActReq('${a.id}')" class="text-slate-300 hover:text-red-500 transition-all p-2 rounded-lg hover:bg-red-50"><i data-lucide="trash-2" size="18"></i></button></td>
                                            </tr>`}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
            },
            calendar: () => {
                return `
                    ${window.getStrategicIndicatorsHTML()}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 animate-fadeIn">
                        ${window.MONTHS_DATA.map(m => {
                            const mActs = window.state.activities.filter(a => parseInt(a.month) === m.id);
                            return `
                                <div class="bg-white rounded-3xl border shadow-sm overflow-hidden flex flex-col min-h-[220px] print-break-inside-avoid">
                                    <div class="px-5 py-4 ${m.color} bg-slate-50 border-b flex justify-between items-center">
                                        <h3 class="font-black text-xs uppercase tracking-tighter text-slate-700">${m.name}</h3>
                                        <span class="text-[9px] font-black bg-white border px-2 py-0.5 rounded-full text-slate-500 shadow-sm">${mActs.length} AÇÕES</span>
                                    </div>
                                    <div class="p-4 flex-1 overflow-y-auto custom-scrollbar max-h-56">
                                        <ul class="space-y-2.5">
                                            ${mActs.map(a => `<li class="text-[10px] flex items-start gap-2 leading-tight">
                                                <span class="w-2 h-2 rounded-full mt-1 flex-shrink-0 ${a.status === 'Concluído' ? 'bg-emerald-500' : 'bg-blue-500'}"></span>
                                                <div class="flex-1"><span class="font-black text-slate-800">${a.date ? a.date.split('-')[2] : '??'}</span> <span class="text-slate-500 font-medium truncate">${a.eventName || 'S/ Nome'}</span></div>
                                            </li>`).join('') || '<li class="text-[9px] text-slate-300 italic text-center py-10 uppercase font-black">Vazio</li>'}
                                        </ul>
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>`;
            },
            reports: () => {
                const m = window.MONTHS_DATA[window.state.selectedMonth];
                const rep = window.state.monthlyReports[m.id] || { explanation: '', axis: '' };
                return `
                    ${window.getStrategicIndicatorsHTML()}
                    <div class="space-y-8 animate-fadeIn max-w-5xl mx-auto">
                        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-8 rounded-[2rem] border shadow-sm gap-6 no-print">
                            <div><h2 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Relatórios de Gestão</h2><p class="text-[10px] font-black text-blue-600 uppercase mt-1 tracking-widest">${m.name}</p></div>
                            <button onclick="window.autoGenRep()" class="bg-blue-50 text-blue-700 px-4 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-blue-100 transition border border-blue-200 flex items-center gap-2"><i data-lucide="sparkles" size="14"></i> Sugestão Automática</button>
                        </div>
                        <div class="bg-white p-10 rounded-[2.5rem] border shadow-sm space-y-10">
                            <div><h3 class="font-black text-slate-800 text-xs uppercase mb-6 border-b pb-4">1. Análise Executiva de Atividades</h3><textarea onblur="window.saveRep('${m.id}', 'explanation', this.value)" class="w-full bg-slate-50 border-none rounded-3xl p-8 h-64 text-sm leading-relaxed text-slate-700 shadow-inner font-medium">${rep.explanation || ''}</textarea></div>
                            <div><h3 class="font-black text-slate-800 text-xs uppercase mb-6 border-b pb-4 flex items-center gap-2"><i data-lucide="layout-grid" size="14"></i> 2. Eixo Transversal (Socioambiental, Ética, Endomarketing)</h3><textarea onblur="window.saveRep('${m.id}', 'axis', this.value)" class="w-full bg-emerald-50/50 border-none rounded-3xl p-8 h-48 text-sm leading-relaxed text-slate-700 shadow-inner font-medium">${rep.axis || ''}</textarea></div>
                        </div>
                    </div>`;
            }
        };

        // --- LÓGICA DE INTERAÇÃO ---
        window.changeView = (v) => { window.state.view = v; window.renderApp(); };
        window.changeMonth = (m) => { window.state.selectedMonth = m; window.renderApp(); };
        window.toggleMobileMenu = () => document.getElementById('mobile-menu')?.classList.toggle('hidden');
        window.closeModal = () => document.getElementById('modal-overlay')?.classList.add('hidden');
        window.exportPDF = () => { setTimeout(() => { window.print(); }, 200); };
        
        window.openConfirm = (msg, cb) => {
            const m = document.getElementById('modal-overlay'), t = document.getElementById('modal-message'), b = document.getElementById('modal-confirm-btn');
            if(m && t && b) { t.innerText = msg; b.onclick = () => { cb(); window.closeModal(); }; m.classList.remove('hidden'); }
        };

        window.addAct = async () => {
            if (!window.db) return;
            const d = { month: window.state.selectedMonth, type: 'Evento Interno', eventName: '', audience: 'Interno', publicCount: 0, date: '2026-02-09', time: '09:00', eventSector: 'Comunicação', postOccurrence: '', satisfaction: 0, status: 'Planejado', createdAt: new Date().toISOString() };
            await addDoc(collection(window.db, 'artifacts', appId, 'public', 'data', 'activities'), d);
        };
        window.saveAct = async (id, f, v) => { if (window.db) await updateDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'activities', id), { [f]: v }); };
        window.delActReq = (id) => window.openConfirm("Deseja eliminar este registo permanentemente?", () => deleteDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'activities', id)));

        window.sendNotif = async () => {
            const i = document.getElementById('notif-input');
            const c = document.getElementById('notif-cat');
            if(i?.value.trim()) { 
                await addDoc(collection(window.db, 'artifacts', appId, 'public', 'data', 'notifications'), { text: i.value, category: c.value, timestamp: new Date().toISOString(), author: 'Admin' }); 
                i.value = ''; 
            }
        };
        window.delNotif = async (id) => await deleteDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'notifications', id));

        window.saveRep = async (m, f, v) => { if (window.db) await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'reports', m.toString()), { [f]: v }, { merge: true }); };
        
        window.autoGenRep = () => {
            const acts = window.state.activities.filter(a => parseInt(a.month) === window.state.selectedMonth);
            const done = acts.filter(a => a.status === 'Concluído').length;
            const mName = window.MONTHS_DATA[window.state.selectedMonth].name.toUpperCase();
            let txt = `RELATÓRIO MENSAL - ${mName} 2026\n\nExecução de ${acts.length} ações coordenadas pelo Setor de Comunicação. `;
            if(window.state.selectedMonth === 0) txt += "Destaque para o 'Janeiro Branco - CGA-2026' com 91% de satisfação média.";
            window.saveRep(window.state.selectedMonth, 'explanation', txt);
            window.saveRep(window.state.selectedMonth, 'axis', "Ações em plena conformidade com os eixos de Socioambiental, Ética e Endomarketing institucional.");
        };

        // --- POPULAÇÃO INICIAL (PDF + DOCX) ---
        async function populateDatabase() {
            if (!window.db) return;
            const actsCol = collection(window.db, 'artifacts', appId, 'public', 'data', 'activities');
            const snap = await getDocs(actsCol);
            if (snap.empty) {
                const schedule = [
                    { month: 0, type: 'Gravação', eventName: 'Websérie - Keilah Fonseca', audience: 'Externo', publicCount: 10, eventSector: 'CCSRI', date: '2026-01-16', postOccurrence: 'Gravação concluída.', satisfaction: 100, status: 'Concluído' },
                    { month: 0, type: 'Evento Interno', eventName: 'Janeiro Branco - CGA-2026', audience: 'Interno', publicCount: 41, eventSector: 'CGA', date: '2026-01-27', postOccurrence: 'NPS: 65.8. Palestras sobre saúde mental e ética.', satisfaction: 91, status: 'Concluído' },
                    { month: 0, type: 'Palestra', eventName: 'Dia Mundial da Cultura Africana', audience: 'Comunidade', publicCount: 30, eventSector: 'CCSRI', date: '2026-01-23', postOccurrence: 'Palestra Keila Quilombo.', satisfaction: 95, status: 'Concluído' }
                ];
                for (const item of schedule) { await addDoc(actsCol, { ...item, createdAt: new Date().toISOString() }); }
            }
        }

        async function start() {
            const app = initializeApp(firebaseConfig);
            window.auth = getAuth(app); 
            window.db = getFirestore(app);
            const printDate = document.getElementById('print-date');
            if(printDate) printDate.innerText = new Date().toLocaleDateString();
            
            try {
                await signInAnonymously(window.auth);
                onAuthStateChanged(window.auth, async (u) => {
                    if (u) {
                        const dot = document.getElementById('conn-dot'), txt = document.getElementById('conn-text');
                        if(dot) dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
                        if(txt) txt.innerText = "ONLINE";
                        
                        await populateDatabase();
                        
                        onSnapshot(collection(window.db, 'artifacts', appId, 'public', 'data', 'activities'), s => { 
                            window.state.activities = s.docs.map(d => ({id: d.id, ...d.data()})); 
                            window.renderApp(); 
                        });
                        onSnapshot(collection(window.db, 'artifacts', appId, 'public', 'data', 'notifications'), s => { 
                            window.state.notifications = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); 
                            window.renderApp(); 
                        });
                        onSnapshot(collection(window.db, 'artifacts', appId, 'public', 'data', 'reports'), s => { 
                            const r = {}; s.docs.forEach(d => r[d.id] = d.data()); 
                            window.state.monthlyReports = r; 
                            window.renderApp(); 
                        });
                    }
                });
            } catch (e) { window.renderApp(); }
        }
        
        start();
    </script>
</body>
</html>



